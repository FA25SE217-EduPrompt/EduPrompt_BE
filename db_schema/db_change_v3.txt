ALTER TABLE prompt_usages
    ADD COLUMN ai_model VARCHAR(255) DEFAULT 'gpt-4o-mini',
    ADD COLUMN output TEXT,
    ADD COLUMN execution_time_ms INT;


CREATE TABLE user_quota (
                            id UUID PRIMARY KEY,
                            user_id UUID NOT NULL UNIQUE,
                            subscription_id UUID NOT NULL,
                            testing_quota_remaining INT,
                            testing_quota_limit INT,
                            optimization_quota_remaining INT,
                            optimization_quota_limit INT,
                            quota_reset_date TIMESTAMP,
                            created_at TIMESTAMP DEFAULT now(),
                            updated_at TIMESTAMP,
                            FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
                            FOREIGN KEY (subscription_id) REFERENCES subscription(id)
);

CREATE TABLE optimization_queue (
                                    id UUID PRIMARY KEY,
                                    prompt_id UUID NOT NULL,
                                    requested_by UUID NOT NULL,
                                    input TEXT NOT NULL,
                                    status VARCHAR(50) DEFAULT 'pending', -- pending, processing, completed, failed
                                    ai_model VARCHAR(255) DEFAULT 'gpt-4o-mini',
                                    output TEXT,
                                    error_message TEXT,
                                    created_at TIMESTAMP DEFAULT now(),
                                    updated_at TIMESTAMP,
                                    FOREIGN KEY (prompt_id) REFERENCES prompts(id) ON DELETE CASCADE,
                                    FOREIGN KEY (requested_by) REFERENCES users(id) ON DELETE CASCADE
);

ALTER TABLE optimization_queue
    ADD COLUMN idempotency_key VARCHAR(255) UNIQUE, -- Prevent duplicate requests
    ADD COLUMN retry_count INT DEFAULT 0,

ALTER TABLE prompt_usages
    ADD COLUMN idempotency_key VARCHAR(255) UNIQUE;

ALTER TABLE ai_suggestion_logs
    ADD COLUMN optimization_queue_id UUID,
    ADD FOREIGN KEY (optimization_queue_id) REFERENCES optimization_queue(id) ON DELETE SET NULL;

ALTER TABLE attachments
    ADD COLUMN IF NOT EXISTS public_id VARCHAR(255) , -- if public id is null, that means attachment url is public
    ADD COLUMN IF NOT EXISTS file_name VARCHAR(255),
    ADD COLUMN IF NOT EXISTS size BIGINT;

CREATE INDEX idx_userquota_user ON user_quota(user_id);
CREATE INDEX idx_userquota_reset_date ON user_quota(quota_reset_date);
CREATE INDEX idx_optqueue_status ON optimization_queue(status);
CREATE INDEX idx_optqueue_requested_by ON optimization_queue(requested_by);
CREATE INDEX idx_optqueue_created ON optimization_queue(created_at);
CREATE INDEX idx_prompt_usages_user_model ON prompt_usages(user_id, ai_model, created_at);